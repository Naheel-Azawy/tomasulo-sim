<html>
    <head>

        <meta charset="utf-8" />
        <title>Tomasulo</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <style>
         body, button, select, input, a, textarea {
             color:       #ffffff;
             text-shadow: 0px 4px 8px rgba(0,0,0,0.5);
             font-family: monospace;
         }

         body, button, select, input, textarea {
             background-color: #000000;
         }

         hr {
             display:    block;
             height:     1px;
             border:     0;
             border-top: 0.3em solid white;
             margin:     1em 0;
             padding:    0;
         }
        </style>

        <script src="tomasulo.js"></script>
    </head>
    <body>
        <div style="margin:auto;max-width:700px">
            <div style="text-align:center">
                <h1>Tomasulo Simulator</h1>
                <hr>
                By
                <a href="https://naheel-azawy.github.io">Naheel</a>
                - Source at <a href="https://github.com/Naheel-Azawy/tomasulo-sim">GitHub</a>

                <h2>Source <button onclick="run()">RUN</button></h2>
                <textarea id="src" rows="20" cols="50" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
LD    F0  0   R1
MULTD F4  F0  F2
SD    F4  0   R1
SUBI  R1  R1  #8
BNE   R1  R0   0

INIT:
R.R1 = 80
IS.MULTD.clks = 4
// 1st load takes 8 clocks (L1 cache miss) and
// 2nd load takes 1 clock (hit)
IS.LD.clks = [8, 1]
                </textarea>
                <br>

                <h2>Output</h2>
                <center>
                    <table>
                        <td><button onclick="prev()">&lt PREV</button></td>
                        <td><input id="ck" type="text" style="text-align:center" value="1"></td>
                        <td><button onclick="next()">NEXT &gt</button></td>
                    </table>
                    <div id="ck-count"></div><br>
                    Hints: Enter "all" to show all clocks at once.<br>
                    Use arrow keys to move between clocks.<br><br>
                </center>

            </div>

            <div id="out" style="white-space:pre"></div>

        </div>

        <script>
         let tomasulo_out = [];
         function show_ck(ck) {
             if (String(ck).toLowerCase() == "all") {
                 document.getElementById("ck").value = "ALL";
                 document.getElementById("out").innerText = tomasulo_out.join("");
                 return;
             } else if (isNaN(ck)) {
                 ck = 1;
             } else if (ck < 1) {
                 ck = 1;
             } else if (ck > tomasulo_out.length) {
                 ck = tomasulo_out.length;
             }
             document.getElementById("ck").value = ck;
             document.getElementById("out").innerText = tomasulo_out[ck - 1];
         }

         function next() {
             show_ck(+document.getElementById("ck").value + 1);
         }

         function prev() {
             show_ck(document.getElementById("ck").value - 1);
         }

         function run() {
             tomasulo_out = tomasulo(document.getElementById("src").value, true);
             document.getElementById("ck-count").innerText =
                 "out of " + tomasulo_out.length + " clock cycles";
             show_ck(1);
         }

         document.getElementById("ck").addEventListener('keyup', event => {
             if (event.keyCode === 13) {
                 show_ck(document.getElementById("ck").value)
             }
         });

         document.onkeydown = event => {
             switch (event.key) {
                 case "ArrowRight": next(); break;
                 case "ArrowLeft":  prev(); break;
             }
         };

         run();
        </script>
    </body>
</html>
